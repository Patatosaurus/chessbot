#include <stdio.h>
#include <stdint.h>
#include <stdbool.h>

#define lsb(num) (1ULL<<__builtin_ctzll(num))
#define msb(num) (1ULL <<(63-__builtin_clzll(num)))
#define getSquare(num) (__builtin_ctzll(num))

const uint64_t pawnsAttacks[2][48]  = {{2, 5, 10, 20, 40, 80, 160, 64, 512, 1280, 2560, 5120, 10240, 20480, 40960, 16384, 131072, 327680, 655360, 1310720, 2621440, 5242880, 10485760, 4194304, 33554432, 83886080, 167772160, 335544320, 671088640, 1342177280, 2684354560, 1073741824, 8589934592, 21474836480, 42949672960, 85899345920, 171798691840, 343597383680, 687194767360, 274877906944, 2199023255552, 5497558138880, 10995116277760, 21990232555520, 43980465111040, 87960930222080, 175921860444160, 70368744177664}, {131072, 327680, 655360, 1310720, 2621440, 5242880, 10485760, 4194304, 33554432, 83886080, 167772160, 335544320, 671088640, 1342177280, 2684354560, 1073741824, 8589934592, 21474836480, 42949672960, 85899345920, 171798691840, 343597383680, 687194767360, 274877906944, 2199023255552, 5497558138880, 10995116277760, 21990232555520, 43980465111040, 87960930222080, 175921860444160, 70368744177664, 562949953421312, 1407374883553280, 2814749767106560, 5629499534213120, 11258999068426240, 22517998136852480, 45035996273704960, 18014398509481984, 144115188075855872, 360287970189639680, 720575940379279360, 1441151880758558720, 2882303761517117440, 5764607523034234880, 11529215046068469760ULL, 4611686018427387904}};
const uint64_t knightsAttacks[64] = {132096, 329728, 659712, 1319424, 2638848, 5277696, 10489856, 4202496, 33816580, 84410376, 168886289, 337772578, 675545156, 1351090312, 2685403152, 1075839008, 8657044482, 21609056261, 43234889994, 86469779988, 172939559976, 345879119952, 687463207072, 275414786112, 2216203387392, 5531918402816, 11068131838464, 22136263676928, 44272527353856, 88545054707712, 175990581010432, 70506185244672, 567348067172352, 1416171111120896, 2833441750646784, 5666883501293568, 11333767002587136, 22667534005174272, 45053588738670592, 18049583422636032, 145241105196122112, 362539804446949376, 725361088165576704, 1450722176331153408, 2901444352662306816, 5802888705324613632, 11533718717099671552ULL, 4620693356194824192, 288234782788157440, 576469569871282176, 1224997833292120064, 2449995666584240128, 4899991333168480256, 9799982666336960512ULL, 1152939783987658752, 2305878468463689728, 1128098930098176, 2257297371824128, 4796069720358912, 9592139440717824, 19184278881435648, 38368557762871296, 4679521487814656, 9077567998918656};
const uint64_t kingsAttacks[64] = {770, 1797, 3594, 7188, 14376, 28752, 57504, 49216, 197123, 460039, 920078, 1840156, 3680312, 7360624, 14721248, 12599488, 50463488, 117769984, 235539968, 471079936, 942159872, 1884319744, 3768639488, 3225468928, 12918652928, 30149115904, 60298231808, 120596463616, 241192927232, 482385854464, 964771708928, 825720045568, 3307175149568, 7718173671424, 15436347342848, 30872694685696, 61745389371392, 123490778742784, 246981557485568, 211384331665408, 846636838289408, 1975852459884544, 3951704919769088, 7903409839538176, 15806819679076352, 31613639358152704, 63227278716305408, 54114388906344448, 216739030602088448, 505818229730443264, 1011636459460886528, 2023272918921773056, 4046545837843546112, 8093091675687092224, 16186183351374184448ULL, 13853283560024178688ULL, 144959613005987840, 362258295026614272, 724516590053228544, 1449033180106457088, 2898066360212914176, 5796132720425828352, 11592265440851656704ULL, 4665729213955833856};
const uint64_t slidingAttacksList[64][8] = {{0ULL, 0ULL, 0ULL, 9241421688590303744ULL, 0ULL, 0ULL, 72340172838076672ULL, 254ULL}, {0ULL, 0ULL, 256ULL, 36099303471055872ULL, 0ULL, 1ULL, 144680345676153344ULL, 252ULL}, {0ULL, 0ULL, 66048ULL, 141012904183808ULL, 0ULL, 3ULL, 289360691352306688ULL, 248ULL}, {0ULL, 0ULL, 16909312ULL, 550831656960ULL, 0ULL, 7ULL, 578721382704613376ULL, 240ULL}, {0ULL, 0ULL, 4328785920ULL, 2151686144ULL, 0ULL, 15ULL, 1157442765409226752ULL, 224ULL}, {0ULL, 0ULL, 1108169199616ULL, 8404992ULL, 0ULL, 31ULL, 2314885530818453504ULL, 192ULL}, {0ULL, 0ULL, 283691315109888ULL, 32768ULL, 0ULL, 63ULL, 4629771061636907008ULL, 128ULL}, {0ULL, 0ULL, 72624976668147712ULL, 0ULL, 0ULL, 127ULL, 9259542123273814016ULL, 0ULL}, {0ULL, 2ULL, 0ULL, 4620710844295151616ULL, 1ULL, 0ULL, 72340172838076416ULL, 65024ULL}, {1ULL, 4ULL, 65536ULL, 9241421688590303232ULL, 2ULL, 256ULL, 144680345676152832ULL, 64512ULL}, {2ULL, 8ULL, 16908288ULL, 36099303471054848ULL, 4ULL, 768ULL, 289360691352305664ULL, 63488ULL}, {4ULL, 16ULL, 4328783872ULL, 141012904181760ULL, 8ULL, 1792ULL, 578721382704611328ULL, 61440ULL}, {8ULL, 32ULL, 1108169195520ULL, 550831652864ULL, 16ULL, 3840ULL, 1157442765409222656ULL, 57344ULL}, {16ULL, 64ULL, 283691315101696ULL, 2151677952ULL, 32ULL, 7936ULL, 2314885530818445312ULL, 49152ULL}, {32ULL, 128ULL, 72624976668131328ULL, 8388608ULL, 64ULL, 16128ULL, 4629771061636890624ULL, 32768ULL}, {64ULL, 0ULL, 145249953336262656ULL, 0ULL, 128ULL, 32512ULL, 9259542123273781248ULL, 0ULL}, {0ULL, 516ULL, 0ULL, 2310355422147510272ULL, 257ULL, 0ULL, 72340172838010880ULL, 16646144ULL}, {256ULL, 1032ULL, 16777216ULL, 4620710844295020544ULL, 514ULL, 65536ULL, 144680345676021760ULL, 16515072ULL}, {513ULL, 2064ULL, 4328521728ULL, 9241421688590041088ULL, 1028ULL, 196608ULL, 289360691352043520ULL, 16252928ULL}, {1026ULL, 4128ULL, 1108168671232ULL, 36099303470530560ULL, 2056ULL, 458752ULL, 578721382704087040ULL, 15728640ULL}, {2052ULL, 8256ULL, 283691314053120ULL, 141012903133184ULL, 4112ULL, 983040ULL, 1157442765408174080ULL, 14680064ULL}, {4104ULL, 16512ULL, 72624976666034176ULL, 550829555712ULL, 8224ULL, 2031616ULL, 2314885530816348160ULL, 12582912ULL}, {8208ULL, 32768ULL, 145249953332068352ULL, 2147483648ULL, 16448ULL, 4128768ULL, 4629771061632696320ULL, 8388608ULL}, {16416ULL, 0ULL, 290499906664136704ULL, 0ULL, 32896ULL, 8323072ULL, 9259542123265392640ULL, 0ULL}, {0ULL, 132104ULL, 0ULL, 1155177711056977920ULL, 65793ULL, 0ULL, 72340172821233664ULL, 4261412864ULL}, {65536ULL, 264208ULL, 4294967296ULL, 2310355422113955840ULL, 131586ULL, 16777216ULL, 144680345642467328ULL, 4227858432ULL}, {131328ULL, 528416ULL, 1108101562368ULL, 4620710844227911680ULL, 263172ULL, 50331648ULL, 289360691284934656ULL, 4160749568ULL}, {262657ULL, 1056832ULL, 283691179835392ULL, 9241421688455823360ULL, 526344ULL, 117440512ULL, 578721382569869312ULL, 4026531840ULL}, {525314ULL, 2113664ULL, 72624976397598720ULL, 36099303202095104ULL, 1052688ULL, 251658240ULL, 1157442765139738624ULL, 3758096384ULL}, {1050628ULL, 4227072ULL, 145249952795197440ULL, 141012366262272ULL, 2105376ULL, 520093696ULL, 2314885530279477248ULL, 3221225472ULL}, {2101256ULL, 8388608ULL, 290499905590394880ULL, 549755813888ULL, 4210752ULL, 1056964608ULL, 4629771060558954496ULL, 2147483648ULL}, {4202512ULL, 0ULL, 580999811180789760ULL, 0ULL, 8421504ULL, 2130706432ULL, 9259542121117908992ULL, 0ULL}, {0ULL, 33818640ULL, 0ULL, 577588851233521664ULL, 16843009ULL, 0ULL, 72340168526266368ULL, 1090921693184ULL}, {16777216ULL, 67637280ULL, 1099511627776ULL, 1155177702467043328ULL, 33686018ULL, 4294967296ULL, 144680337052532736ULL, 1082331758592ULL}, {33619968ULL, 135274560ULL, 283673999966208ULL, 2310355404934086656ULL, 67372036ULL, 12884901888ULL, 289360674105065472ULL, 1065151889408ULL}, {67240192ULL, 270549120ULL, 72624942037860352ULL, 4620710809868173312ULL, 134744072ULL, 30064771072ULL, 578721348210130944ULL, 1030792151040ULL}, {134480385ULL, 541097984ULL, 145249884075720704ULL, 9241421619736346624ULL, 269488144ULL, 64424509440ULL, 1157442696420261888ULL, 962072674304ULL}, {268960770ULL, 1082130432ULL, 290499768151441408ULL, 36099165763141632ULL, 538976288ULL, 133143986176ULL, 2314885392840523776ULL, 824633720832ULL}, {537921540ULL, 2147483648ULL, 580999536302882816ULL, 140737488355328ULL, 1077952576ULL, 270582939648ULL, 4629770785681047552ULL, 549755813888ULL}, {1075843080ULL, 0ULL, 1161999072605765632ULL, 0ULL, 2155905152ULL, 545460846592ULL, 9259541571362095104ULL, 0ULL}, {0ULL, 8657571872ULL, 0ULL, 288793326105133056ULL, 4311810305ULL, 0ULL, 72339069014638592ULL, 279275953455104ULL}, {4294967296ULL, 17315143744ULL, 281474976710656ULL, 577586652210266112ULL, 8623620610ULL, 1099511627776ULL, 144678138029277184ULL, 277076930199552ULL}, {8606711808ULL, 34630287488ULL, 72620543991349248ULL, 1155173304420532224ULL, 17247241220ULL, 3298534883328ULL, 289356276058554368ULL, 272678883688448ULL}, {17213489152ULL, 69260574720ULL, 145241087982698496ULL, 2310346608841064448ULL, 34494482440ULL, 7696581394432ULL, 578712552117108736ULL, 263882790666240ULL}, {34426978560ULL, 138521083904ULL, 290482175965396992ULL, 4620693217682128896ULL, 68988964880ULL, 16492674416640ULL, 1157425104234217472ULL, 246290604621824ULL}, {68853957121ULL, 277025390592ULL, 580964351930793984ULL, 9241386435364257792ULL, 137977929760ULL, 34084860461056ULL, 2314850208468434944ULL, 211106232532992ULL}, {137707914242ULL, 549755813888ULL, 1161928703861587968ULL, 36028797018963968ULL, 275955859520ULL, 69269232549888ULL, 4629700416936869888ULL, 140737488355328ULL}, {275415828484ULL, 0ULL, 2323857407723175936ULL, 0ULL, 551911719040ULL, 139637976727552ULL, 9259400833873739776ULL, 0ULL}, {0ULL, 2216338399296ULL, 0ULL, 144115188075855872ULL, 1103823438081ULL, 0ULL, 72057594037927936ULL, 71494644084506624ULL}, {1099511627776ULL, 4432676798592ULL, 72057594037927936ULL, 288230376151711744ULL, 2207646876162ULL, 281474976710656ULL, 144115188075855872ULL, 70931694131085312ULL}, {2203318222848ULL, 8865353596928ULL, 144115188075855872ULL, 576460752303423488ULL, 4415293752324ULL, 844424930131968ULL, 288230376151711744ULL, 69805794224242688ULL}, {4406653222912ULL, 17730707128320ULL, 288230376151711744ULL, 1152921504606846976ULL, 8830587504648ULL, 1970324836974592ULL, 576460752303423488ULL, 67553994410557440ULL}, {8813306511360ULL, 35461397479424ULL, 576460752303423488ULL, 2305843009213693952ULL, 17661175009296ULL, 4222124650659840ULL, 1152921504606846976ULL, 63050394783186944ULL}, {17626613022976ULL, 70918499991552ULL, 1152921504606846976ULL, 4611686018427387904ULL, 35322350018592ULL, 8725724278030336ULL, 2305843009213693952ULL, 54043195528445952ULL}, {35253226045953ULL, 140737488355328ULL, 2305843009213693952ULL, 9223372036854775808ULL, 70644700037184ULL, 17732923532771328ULL, 4611686018427387904ULL, 36028797018963968ULL}, {70506452091906ULL, 0ULL, 4611686018427387904ULL, 0ULL, 141289400074368ULL, 35747322042253312ULL, 9223372036854775808ULL, 0ULL}, {0ULL, 567382630219904ULL, 0ULL, 0ULL, 282578800148737ULL, 0ULL, 0ULL, 18302628885633695744ULL}, {281474976710656ULL, 1134765260439552ULL, 0ULL, 0ULL, 565157600297474ULL, 72057594037927936ULL, 0ULL, 18158513697557839872ULL}, {564049465049088ULL, 2269530520813568ULL, 0ULL, 0ULL, 1130315200594948ULL, 216172782113783808ULL, 0ULL, 17870283321406128128ULL}, {1128103225065472ULL, 4539061024849920ULL, 0ULL, 0ULL, 2260630401189896ULL, 504403158265495552ULL, 0ULL, 17293822569102704640ULL}, {2256206466908160ULL, 9078117754732544ULL, 0ULL, 0ULL, 4521260802379792ULL, 1080863910568919040ULL, 0ULL, 16140901064495857664ULL}, {4512412933881856ULL, 18155135997837312ULL, 0ULL, 0ULL, 9042521604759584ULL, 2233785415175766016ULL, 0ULL, 13835058055282163712ULL}, {9024825867763968ULL, 36028797018963968ULL, 0ULL, 0ULL, 18085043209519168ULL, 4539628424389459968ULL, 0ULL, 9223372036854775808ULL}, {18049651735527937ULL, 0ULL, 0ULL, 0ULL, 36170086419038336ULL, 9151314442816847872ULL, 0ULL, 0ULL}};

typedef struct {
    bool hasShortCastle;
    bool hasLongCastle;
    uint64_t pawnBitboard;
    uint64_t knightBitboard;
    uint64_t bishopBitboard;
    uint64_t rookBitboard;
    uint64_t queenBitboard;
    uint64_t kingBitboard;
    uint64_t allPieces;
    uint64_t allAttacks;
}color;
typedef struct {
    bool whoesTurn;
    int moveCount;
    color white;
    color black;
    uint64_t allPieces;
}chessboard;
typedef struct {
    uint64_t attacksBitboard;
    uint64_t xrayAttacksBitboard;
}slidingAttack;
typedef struct {
    bool color;
    uint8_t type;
    uint64_t *typeBitboard;
    uint8_t square;
    uint64_t attacksBitboard; // important
    uint64_t xrayAttacksBitboard; // important too
    slidingAttack slidingAttacks[8];
}piece;

enum {
    a1, b1, c1, d1, e1, f1, g1, h1, 
    a2, b2, c2, d2, e2, f2, g2, h2,
    a3, b3, c3, d3, e3, f3, g3, h3, 
    a4, b4, c4, d4, e4, f4, g4, h4,
    a5, b5, c5, d5, e5, f5, g5, h5, 
    a6, b6, c6, d6, e6, f6, g6, h6,
    a7, b7, c7, d7, e7, f7, g7, h7, 
    a8, b8, c8, d8, e8, f8, g8, h8
};
enum {
    pawn, knight, 
    bishop, rook, 
    queen, king
};


void printBitboard(uint64_t bitboard) {
    for (int rank=7; rank >=0; rank--) {
        for (int file=0; file<8; file++) {
            int square = rank*8+file;
            if ((bitboard >> square) & 1){
                printf("%d ", (bitboard >> square) & 1);}
            else{
                printf("* ");}
        }
        printf("\n");
    }
    printf("\n");
}

slidingAttack calculateSlidingAttacks(uint8_t square, bool isMsb, uint8_t direction, uint64_t allPieces) {
    slidingAttack newSlindingAttack = {0};
    uint64_t withoutBlockers = slidingAttacksList[square][direction];
    uint64_t blockers = withoutBlockers & allPieces;
    if (blockers==0) {
        newSlindingAttack.attacksBitboard = withoutBlockers;
        newSlindingAttack.xrayAttacksBitboard = withoutBlockers;
        return newSlindingAttack;
    }

    uint64_t firstBlocker = isMsb ? msb(blockers) : lsb(blockers);
    uint64_t firstBlockerAttack = slidingAttacksList[getSquare(firstBlocker)][direction];
    blockers ^= firstBlocker;

    newSlindingAttack.attacksBitboard = withoutBlockers ^ firstBlockerAttack;

    if (blockers==0) {
        newSlindingAttack.xrayAttacksBitboard = withoutBlockers;
        return newSlindingAttack;
    }

    uint64_t secondBlocker = isMsb ? msb(blockers) : lsb(blockers);
    uint64_t secondBlockerAttack = slidingAttacksList[getSquare(secondBlocker)][direction];
    newSlindingAttack.xrayAttacksBitboard = withoutBlockers ^ secondBlockerAttack;
    return newSlindingAttack;
}

uint64_t calculatePawnsAttacks(bool color, uint8_t square) {
    return pawnsAttacks[color][square-8];
}
uint64_t calculateKnightsAttacks(uint8_t square) {
    return knightsAttacks[square];
}
uint64_t calculateKingsAttacks(uint8_t square) {
    return kingsAttacks[square];
}
void calculateBishopsAttacks(uint8_t square, uint64_t allPieces, slidingAttack*slidingAttacks) {
    slidingAttacks[0] = calculateSlidingAttacks(square, true, 0, allPieces);
    slidingAttacks[1] = calculateSlidingAttacks(square, true, 1, allPieces);
    slidingAttacks[2] = calculateSlidingAttacks(square, false, 2, allPieces);
    slidingAttacks[3] = calculateSlidingAttacks(square, false, 3, allPieces);
}
void calculateRooksAttacks(uint8_t square, uint64_t allPieces, slidingAttack*slidingAttacks) {
    slidingAttacks[4] = calculateSlidingAttacks(square, true, 4, allPieces);
    slidingAttacks[5] = calculateSlidingAttacks(square, true, 5, allPieces);
    slidingAttacks[6] = calculateSlidingAttacks(square, false, 6, allPieces);
    slidingAttacks[7] = calculateSlidingAttacks(square, false, 7, allPieces);
}
void calculateQueensAttacks(uint8_t square, uint64_t allPieces, slidingAttack*slidingAttacks) {
    calculateBishopsAttacks(square, allPieces, slidingAttacks);
    calculateRooksAttacks(square, allPieces, slidingAttacks);
}

void startGame(){
    chessboard chessGame = {.whoesTurn=true, .allPieces=0xFFFF00000000FFFF, .moveCount=0, 
                .white.allPieces=0x000000000000FFFF, }; 
}


int main() {
    chessboard newChessboard = {0};
    newChessboard.allPieces = 0xFFFF00000000FFFF;
    piece newPiece = {.square=35};
    calculateQueensAttacks(newPiece.square,newChessboard.allPieces, newPiece.slidingAttacks);


    // printBitboard(newChessboard.allPieces);
    printBitboard(newPiece.slidingAttacks[5].attacksBitboard);
    printBitboard(newPiece.slidingAttacks[5].xrayAttacksBitboard);
    return 0;
}